#!/bin/bash

set -euo pipefail

RSYNC_DIR="@PREFIX@/var/rsync/macports"
RSYNC_MODULES="distfiles release trunk"

#RSYNC_URL_FORMAT="rsync://rsync-origin.macports.org/%s/"
#RSYNC_URL_FORMAT="rsync://cjj.kr.rsync.macports.org/macports/%s/"
#RSYNC_URL_FORMAT="rsync://fco.it.rsync.macports.org/macports-%s/"
#RSYNC_URL_FORMAT="rsync://jnb.za.rsync.macports.org/macports/%s/"
#RSYNC_URL_FORMAT="rsync://jog.id.rsync.macports.org/macports/%s/"
#RSYNC_URL_FORMAT="rsync://lil.fr.rsync.macports.org/%s/"
#RSYNC_URL_FORMAT="rsync://mse.uk.rsync.macports.org/%s.macports.org/"
#RSYNC_URL_FORMAT="rsync://nou.nc.rsync.macports.org/macports/%s.macports.org/"
#RSYNC_URL_FORMAT="rsync://nue.de.rsync.macports.org/macports/%s/"
#RSYNC_URL_FORMAT="rsync://osl.no.rsync.macports.org/%s/"
#RSYNC_URL_FORMAT="rsync://sea.us.rsync.macports.org/%s/"
RSYNC_URL_FORMAT="rsync://sjc.us.rsync.macports.org/%s/"

RSYNC="@PREFIX@/bin/rsync"
TS="@PREFIX@/bin/ts %Y-%m-%dT%H:%M:%S%z"
RSYNC_ARGS="--compress --delete-delay --hard-links --links --no-motd --perms --recursive --stats --timeout=600 --times"
if [ -t 1 ]; then
    RSYNC_ARGS="$RSYNC_ARGS --info=progress2"
fi

for RSYNC_MODULE in $RSYNC_MODULES; do
    RSYNC_URL="$(printf "$RSYNC_URL_FORMAT" "$RSYNC_MODULE")"
    echo "Syncing from $RSYNC_URL to $RSYNC_DIR/$RSYNC_MODULE" | $TS
    "$RSYNC" $RSYNC_ARGS "$RSYNC_URL" "$RSYNC_DIR/$RSYNC_MODULE" | $TS
    echo | $TS
done
